<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Friends are Friends Forever ‚Äî Weekly Match</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  :root{
    --bg-primary:#0a0d1a;--surface:rgba(26,31,55,.9);--border:rgba(255,255,255,.08);
    --text:#fff;--muted:#a8b3cf;--accent:#3b82f6;--glow:rgba(59,130,246,.3);
    --ok:#10b981;--bad:#ef4444;
  }
  *{box-sizing:border-box}html,body{height:100%;margin:0}
  body{
    font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);
    background-image:
      radial-gradient(circle at 20% 50%, rgba(59,130,246,.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(139,92,246,.1) 0%, transparent 50%),
      radial-gradient(circle at 40% 80%, rgba(236,72,153,.05) 0%, transparent 50%);
    color:var(--text); line-height:1.6; min-height:100vh; overflow-x:hidden}
  .container{max-width:1100px;margin:0 auto;padding:24px 16px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:16px 18px;margin-bottom:18px}
  h1{font-size:36px;margin:6px 0 4px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .tag{display:inline-flex;gap:.5rem;align-items:center;padding:.4rem .8rem;border:1px solid var(--border);
    border-radius:999px;background:rgba(255,255,255,.05);color:#dbeafe;font-weight:600}
  .row{display:grid;gap:18px}
  @media(min-width:980px){.row{grid-template-columns:420px 1fr}}
  label{font-size:.85rem;color:#c7d2fe}
  input,select,textarea{width:100%;padding:.7rem .9rem;border-radius:12px;border:1px solid var(--border);
    background:rgba(255,255,255,.02);color:var(--text)}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:12px;border:1px solid var(--border);
    background:rgba(255,255,255,.06);color:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
  .pill{padding:.25rem .5rem;border-radius:8px;border:1px solid var(--border);font-family:ui-monospace,Menlo,monospace;font-size:.8rem;color:#b6c2e2}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:.6rem .4rem;text-align:left}
  th{color:#a8b3cf;font-weight:700}
  .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:#a8b3cf}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="card">
    <h1>Friends are Friends Forever</h1>
    <div class="flex">
      <span class="tag">Weekly Match</span>
      <span class="pill" id="audit">Audit:</span>
    </div>
  </div>

  <div class="row">
    <!-- Left: Setup / Controls -->
    <div class="card">
      <h3 style="margin-top:6px">‚öôÔ∏è Setup</h3>

      <div class="grid">
        <div>
          <label>Weeks (NFL)</label>
          <input id="weeks" type="number" min="1" max="30" value="14"/>
        </div>
        <div>
          <label>Default Weekly Bet ($)</label>
          <input id="weeklyBet" type="number" min="0" step="1" value="20"/>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Season start (Week 1 Tuesday)</label>
          <input id="seasonStart" type="date"/>
          <div class="muted" style="font-size:.85rem;margin-top:6px">Each NFL week runs Tue 00:00 ‚Üí next Tue 00:00.</div>
        </div>
        <div>
          <label>Lock next week until Tuesday</label>
          <select id="lockUntilTuesday">
            <option value="1" selected>Yes</option>
            <option value="0">No</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Master participants (one per line)</label>
        <textarea id="participants" rows="4"> Matt 
Justin 
Chris 
Christian 
Joe 
Jeff 
Tall Shane 
Noah
Patrick
Robbie</textarea>
        <div class="muted" style="font-size:.85rem;margin-top:6px">Use these names when building the week roster.</div>
      </div>

      <div style="margin-top:10px">
        <label>Teams (one per line)</label>
        <textarea id="teams" rows="6">Bham Bobs
Sunday Morning Wood
Naturally Le'Veon'd
Floatisha's Team 
CLOX 
Whoa Joes
Ginger Balls
Pfffffffffft
Hawk Heaven
Turbo Team</textarea>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Seed (keeps it auditable)</label>
          <input id="seed" placeholder="e.g. 2025-Season"/>
        </div>
        <div>
          <label>Unique teams per week</label>
          <select id="uniquePerWeek">
            <option value="1" selected>Yes (no duplicates)</option>
            <option value="0">No (duplicates allowed)</option>
          </select>
        </div>
      </div>

      <div class="flex" style="margin-top:14px">
        <button class="btn primary" id="revealBtn">üé≤ Reveal Current Week</button>
        <button class="btn" id="settleBtn">‚úÖ Settle Current Week</button>
        <button class="btn" id="shareBtn">üîó Share Link</button>
        <span class="muted">Week <span id="wkNow">1</span> of <span id="wkTotal">14</span></span>
      </div>
    </div>

    <!-- Right: Current Week -->
    <div class="card">
      <h3 style="margin-top:6px">üìÖ Current Week</h3>
      <div id="currentWrap" class="muted">Set this week‚Äôs roster (if needed), then ‚ÄúReveal Current Week.‚Äù</div>
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <h3 style="margin-top:6px">üìú History & Totals</h3>
    <div class="muted" style="margin-bottom:8px">Winner gets all stakes from opponents who played that week.</div>
    <div id="historyWrap" class="muted">Nothing yet. Settle Week 1 to start the ledger.</div>
    <hr style="border-color:rgba(255,255,255,.06)">
    <div id="totalsWrap"></div>
  </div>

  <div class="muted" style="text-align:center;padding:10px 0">¬© <span id="yr"></span> FAF Forever ‚Äî seeded draws, localStorage, shareable URL.</div>
</div>

<script>
// ---------- Helpers ----------
const $ = q => document.querySelector(q);
const nl = el => el.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;
  for(let i=0;i<str.length;i++){let k=str.charCodeAt(i);
    h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860233);
    h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179);}
  h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);
  h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);
  return[(h1^h2^h3^h4)>>>0,(h2^h1)>>>0,(h3^h1)>>>0,(h4^h1)>>>0];}
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);
  t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296}}
function rngFrom(seed){const [h]=cyrb128(seed);return mulberry32(h)}
function hashAudit(s){return cyrb128(s).at(0).toString(16).slice(0,8).toUpperCase()}
const DAY = 24*60*60*1000;

// ---------- State ----------
const STATE_KEY = "FAF_WEEKLY_STATE_V5";
let state = {
  weeks: 14,
  currentWeek: 1,
  participants: ["Robbie","Shane"],   // master list
  teams: [],
  seed: "",
  uniquePerWeek: true,
  defaultBet: 20,
  perWeekBet: {},                     // {week:number}
  weekRoster: {},                     // {week:[names]}  <= NEW
  schedule: {},                       // {week:{picks:{[name]:team}, roster:[names]}}
  results: {},                        // {week:{winner,bet}}
  totals: {},                         // {[participant]: number}
  // NFL calendar
  seasonStart: "",                    // "YYYY-MM-DD" (Week 1 Tuesday)
  lockUntilTuesday: true
};

// ---------- Persistence ----------
function save(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
function load(){ const raw=localStorage.getItem(STATE_KEY); if(raw){ try{ state={...state,...JSON.parse(raw)} }catch{} } }
load();

// ---------- Calendar helpers ----------
function weekNumberFromToday() {
  if (!state.seasonStart) return state.currentWeek;
  const start = new Date(state.seasonStart + "T00:00:00");
  const today = new Date();
  const diffDays = Math.floor((today - start) / DAY);
  return Math.max(1, Math.min(state.weeks, 1 + Math.floor(diffDays / 7)));
}
function weekStartDate(week){ const start=new Date(state.seasonStart+"T00:00:00"); return new Date(start.getTime()+(week-1)*7*DAY); }
function weekEndDate(week){ const ws=weekStartDate(week); return new Date(ws.getTime()+7*DAY); }
function isWithinCurrentWeekWindow(week){ if(!state.seasonStart) return true; const n=new Date(); return n>=weekStartDate(week) && n<weekEndDate(week); }
function hasWeekClosed(week){ if(!state.seasonStart) return true; return new Date()>=weekEndDate(week); }
function fmtDate(d){ return d.toLocaleDateString(undefined,{month:'short',day:'numeric'}); }

// ---------- UI init ----------
function initUI(){
  $('#weeks').value = state.weeks;
  $('#wkTotal').textContent = state.weeks;
  if (state.seasonStart) state.currentWeek = weekNumberFromToday();
  $('#wkNow').textContent = state.currentWeek;
  $('#weeklyBet').value = state.defaultBet;
  $('#participants').value = state.participants.join("\n");
  if(state.teams.length){ $('#teams').value = state.teams.join("\n"); }
  $('#seed').value = state.seed;
  $('#uniquePerWeek').value = state.uniquePerWeek ? "1":"0";
  $('#seasonStart').value = state.seasonStart || "";
  $('#lockUntilTuesday').value = state.lockUntilTuesday ? "1" : "0";
  $('#yr').textContent = new Date().getFullYear();
  $('#audit').textContent = "Audit: " + hashAudit(serializeForAudit());
  renderCurrentWeek(); renderHistory(); renderTotals();
}
function serializeForAudit(){
  return [
    state.weeks,state.participants.join('|'),state.teams.join('|'),
    state.seed,state.uniquePerWeek?1:0,state.currentWeek,state.seasonStart||"",state.lockUntilTuesday?1:0
  ].join('|');
}

// ---------- Inputs ----------
['#weeks','#weeklyBet','#participants','#teams','#seed','#uniquePerWeek','#seasonStart','#lockUntilTuesday']
.forEach(id=>{
  $(id).addEventListener('change', ()=> {
    state.weeks = Math.max(1, Math.min(30, parseInt($('#weeks').value||"14",10)));
    state.defaultBet = Math.max(0, parseFloat($('#weeklyBet').value||"0"));
    state.participants = nl($('#participants'));
    state.teams = nl($('#teams'));
    state.seed = $('#seed').value.trim();
    state.uniquePerWeek = $('#uniquePerWeek').value==="1";
    state.seasonStart = $('#seasonStart').value || "";
    state.lockUntilTuesday = $('#lockUntilTuesday').value==="1";
    if (state.seasonStart) state.currentWeek = weekNumberFromToday();
    $('#wkTotal').textContent = state.weeks;
    $('#wkNow').textContent = state.currentWeek;
    $('#audit').textContent = "Audit: " + hashAudit(serializeForAudit());
    save(); initUI();
  });
});

$('#shareBtn').addEventListener('click', ()=>{
  const sharable = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
  const url = new URL(location.href); url.searchParams.set('state', sharable);
  history.replaceState(null,'',url.toString());
  navigator.clipboard.writeText(url.toString()).then(()=>{
    $('#shareBtn').textContent="‚úÖ Copied"; setTimeout(()=>$('#shareBtn').textContent="üîó Share Link",1500);
  });
});

(function decodeFromUrl(){
  const sp=new URLSearchParams(location.search).get('state');
  if(!sp) return;
  try{ state = {...state, ...JSON.parse(decodeURIComponent(escape(atob(sp))))}; save(); }catch{}
})();

// ---------- Draw / Reveal ----------
function drawWeek(week, roster){
  const seed = (state.seed||"FAF") + "::W" + week;
  const rnd = rngFrom(seed);
  const picks = {};
  const taken = new Set();
  const teams = state.teams.slice();
  if(teams.length < roster.length){ alert("Need ‚â• teams than players this week."); return null; }
  roster.forEach(p=>{
    let pool = teams.slice();
    if(state.uniquePerWeek){ pool = pool.filter(t=>!taken.has(t)); }
    const team = pool[Math.floor(rnd()*pool.length)];
    picks[p] = team; taken.add(team);
  });
  return {week, picks, roster: roster.slice()};
}

function canRevealCurrent(){
  const w = state.currentWeek;
  const prevOk = (w===1) || (state.results[w-1]);
  const notDrawn = !state.schedule[w];
  const inWindow = isWithinCurrentWeekWindow(w);
  return prevOk && notDrawn && inWindow;
}

$('#revealBtn').addEventListener('click', ()=>{
  const w = state.currentWeek;
  if(!isWithinCurrentWeekWindow(w) && state.seasonStart){
    const ws = weekStartDate(w), we = weekEndDate(w);
    alert(`Week ${w} can be revealed only between ${fmtDate(ws)} and ${fmtDate(new Date(we.getTime()-1))}.`);
    return;
  }
  if(!canRevealCurrent()){
    if (state.schedule[w]) { alert("This week is already revealed. Settle it to advance."); }
    else { alert("Finish the previous week first."); }
    return;
  }
  // get roster
  const roster = (state.weekRoster[w] && state.weekRoster[w].length) ? state.weekRoster[w] : state.participants.slice();
  if (roster.length < 2){ alert("Need at least 2 players in this week‚Äôs roster."); return; }
  // validate names exist in master list
  for (const name of roster){ if(!state.participants.includes(name)){ alert(`Unknown player in roster: ${name}`); return; } }
  const sched = drawWeek(w, roster);
  if(!sched) return;
  state.schedule[w] = sched;
  save(); renderCurrentWeek();
});

$('#settleBtn').addEventListener('click', ()=>{
  const w = state.currentWeek;
  const sched = state.schedule[w];
  if(!sched){ alert("Reveal the week first."); return; }
  const roster = sched.roster || ((state.weekRoster[w] && state.weekRoster[w].length)?state.weekRoster[w]:state.participants);
  const winner = prompt("Who won this week? Enter exact name:\n" + roster.join(", "));
  if(!winner || !roster.includes(winner.trim())){ alert("Pick a valid participant from this week‚Äôs roster."); return; }
  const bet = state.perWeekBet[w] ?? state.defaultBet;

  // update participant totals for roster only
  const losers = roster.filter(p=>p!==winner);
  const pot = losers.length * bet;
  roster.forEach(p=>{ if(!(p in state.totals)) state.totals[p]=0; });
  state.totals[winner] += pot;
  losers.forEach(l=> state.totals[l] -= bet);

  state.results[w] = {winner, bet};

  if (state.lockUntilTuesday && state.seasonStart && !hasWeekClosed(w)) {
    alert("Locked until next Tuesday: Week " + (w+1) + " won‚Äôt reveal until the current NFL week closes.");
  }

  if(state.currentWeek < state.weeks){ state.currentWeek += 1; }
  save();
  $('#wkNow').textContent = state.currentWeek;
  renderHistory(); renderTotals(); renderCurrentWeek();
});

// ---------- Renderers ----------
function renderCurrentWeek(){
  const w = state.currentWeek;
  const wrap = $('#currentWrap');
  const sched = state.schedule[w];
  const bet = state.perWeekBet[w] ?? state.defaultBet;

  // roster editor (always visible for current week, even after draw we show picks)
  const rosterNow = (state.weekRoster[w] && state.weekRoster[w].length) ? state.weekRoster[w] : state.participants.slice();
  const rosterTextarea = `
    <div class="grid" style="margin-top:10px">
      <div>
        <label>This week‚Äôs roster (one per line)</label>
        <textarea id="rosterTA" rows="4">${rosterNow.join("\n")}</textarea>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="saveRoster">üíæ Save Roster</button>
      </div>
    </div>
    <div class="muted" style="font-size:.85rem;margin-top:4px">Players must exist in the master list. Need ‚â• 2 players to reveal.</div>
  `;

  if(!sched){
    let weekWindow = '';
    if (state.seasonStart) {
      const ws = weekStartDate(w), we = weekEndDate(w);
      weekWindow = ` (${fmtDate(ws)} ‚Üí ${fmtDate(new Date(we.getTime()-1))})`;
    }
    wrap.innerHTML = `
      <div class="muted">Week ${w}${weekWindow} is not drawn yet. Edit roster if needed, then click <b>Reveal Current Week</b>.</div>
      ${rosterTextarea}
      <div class="grid" style="margin-top:10px">
        <div>
          <label>Override bet for Week ${w} ($)</label>
          <input id="betOverride" type="number" min="0" step="1" value="${bet}">
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="saveBet">üíæ Save Bet</button>
        </div>
      </div>
    `;
    $('#saveRoster').addEventListener('click', ()=>{
      const list = nl($('#rosterTA'));
      state.weekRoster[w] = list;
      save(); renderCurrentWeek();
    });
    $('#saveBet').addEventListener('click', ()=>{
      const v=Math.max(0,parseFloat($('#betOverride').value||"0"));
      state.perWeekBet[w]=v; save(); renderCurrentWeek();
    });
    $('#audit').textContent = "Audit: " + hashAudit(serializeForAudit());
    return;
  }

  const rows = (sched.roster||[]).map(p=>`<tr><td>${p}</td><td>${sched.picks[p]}</td><td>$${bet}</td></tr>`).join('');
  let weekWindow2 = '';
  if (state.seasonStart) {
    const ws = weekStartDate(w), we = weekEndDate(w);
    weekWindow2 = ` ‚Ä¢ ${fmtDate(ws)} ‚Üí ${fmtDate(new Date(we.getTime()-1))}`;
  }

  wrap.innerHTML = `
    <div class="flex" style="justify-content:space-between;flex-wrap:wrap">
      <div><b>Week ${w}</b><span class="muted">${weekWindow2}</span></div>
      <div class="muted">seeded draw ‚Ä¢ <span class="pill">${hashAudit(JSON.stringify(sched))}</span></div>
    </div>
    <table style="margin-top:6px">
      <thead><tr><th>Participant</th><th>Team</th><th>Stake</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    ${rosterTextarea}
    <div class="grid" style="margin-top:10px">
      <div>
        <label>Override bet for Week ${w} ($)</label>
        <input id="betOverride" type="number" min="0" step="1" value="${bet}">
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="saveBet">üíæ Save Bet</button>
      </div>
    </div>
  `;
  $('#saveRoster').addEventListener('click', ()=>{
    const list = nl($('#rosterTA'));
    state.weekRoster[w] = list;
    save(); renderCurrentWeek();
  });
  $('#saveBet').addEventListener('click', ()=>{
    const v=Math.max(0,parseFloat($('#betOverride').value||"0"));
    state.perWeekBet[w]=v; save(); renderCurrentWeek();
  });
  $('#audit').textContent = "Audit: " + hashAudit(serializeForAudit());
}

function renderHistory(){
  const wrap = $('#historyWrap');
  const weeksDone = Object.keys(state.results).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
  if(!weeksDone.length){ wrap.textContent="Nothing yet. Settle Week 1 to start the ledger."; return; }
  const head = `<thead><tr><th>Week</th><th>Roster</th><th>Picks</th><th>Bet</th><th>Winner</th></tr></thead>`;
  const body = weeksDone.map(w=>{
    const sched = state.schedule[w]||{};
    const roster = (sched.roster||[]).join(', ');
    const picks = Object.entries(sched.picks||{}).map(([n,t])=>`${n}: ${t}`).join('; ');
    const bet = state.results[w]?.bet ?? state.defaultBet;
    const winner = state.results[w]?.winner ?? "";
    return `<tr><td>${w}</td><td>${roster}</td><td>${picks}</td><td>$${bet}</td><td>${winner}</td></tr>`;
  }).join('');
  wrap.innerHTML = `<div style="overflow:auto"><table>${head}<tbody>${body}</tbody></table></div>`;
}

function renderTotals(){
  const wrap = $('#totalsWrap');
  const names = Object.keys(state.totals).length ? Object.keys(state.totals) : state.participants;
  const pTotals = names.map(p=>{
    const v = state.totals[p] || 0;
    const sign = v>=0?'+':'';
    return `<div>${p}: <b>${sign}$${v}</b></div>`;
  }).join('');
  wrap.innerHTML = `<div><h4 style="margin:6px 0">Participants totals</h4>${pTotals}</div>`;
}

// boot
initUI();
</script>
</body>
</html>
